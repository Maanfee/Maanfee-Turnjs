@namespace Maanfee.Turnjs
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject TurnjsService Turnjs

<div class="flipbook-viewport">
    <div id="@ElementId" class="flipbook">
        @foreach (var (item, index) in Pages.Select((p, i) => (p, i + 1)))
        {
            <div ignore="@(item.IgnorePage ? 1 : 0)" class="@item.CssClass @item.PageType" data-page-number="@index"
                 style="@(item.IsPageMirror ? "transform: scaleX(-1);" : "transform: scaleX(1);")"
                 dir="@(Options.Direction == TurnjsDirection.LTR ? "ltr" : "rtl")">

                @if (item.IsLoaded)
                {
                    <FlipBookHeader Page="@item" />

                    <FlipBookContent Page="@item" />

                    <FlipBookFooter Page="@item" IndexOfPage="@(Pages.IndexOf(item) + 1)" TotalPages="@TotalPages"
                                    Options="@Options" CurrentPage="@CurrentPage" />
                }
                else
                {
                    <div class="loading-placeholder"></div>
                }

            </div>
        }

    </div>
</div>

@code {
    [Parameter]
    public string ElementId { get; set; } = "flipbook";

    [Parameter]
    public List<TurnjsPage> Pages { get; set; } = new();

    [Parameter]
    public TurnjsOptions Options { get; set; } = new();

    [Parameter]
    public EventCallback<int> PageChanged { get; set; }

    private int CurrentPage = 1;
    private int TotalPages;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Turnjs.OnPageChanged += async (int page, bool isSinglePageView) =>
            {
                CurrentPage = page;
                //  IsSinglePageView = isSinglePageView;

                //  if (isSinglePageView)
                //  {
                //      // در حالت تک صفحه‌ای
                //      IsOddPage = true;
                //      IsEvenPage = false;
                //  }
                //  else
                //  {
                //      // در حالت دو صفحه‌ای
                //      IsOddPage = page % 2 == 1;
                //      IsEvenPage = !IsOddPage;
                //  }

                TotalPages = await GetPageCount();
                StateHasChanged();
                await PageChanged.InvokeAsync(page);
            };
            Turnjs.OnPageChanging += PageChanging;
            await Turnjs.InitializeAsync(ElementId, Options);

            TotalPages = await GetPageCount();
            StateHasChanged();
        }
    }

    public async Task<int> GetPageCount()
    {
        return await Turnjs.GetPageCount();
    }

    public async Task<int> GetCurrentPage()
    {
        return await Turnjs.GetCurrentPage();
    }

    public async ValueTask DisposeAsync()
    {
        await Turnjs.DisposeAsync();
    }

    // ******************************************

    private async Task PageChanging(int pageNumber)
    {
        var adjacentPages = new List<int> { pageNumber, pageNumber - 1, pageNumber + 1, pageNumber - 2, pageNumber + 2 };

        foreach (var pageNum in adjacentPages)
        {
            if (pageNum >= 0 && pageNum < Pages.Count)
            {
                var page = Pages[pageNum];
                if (!page.IsLoaded && page.LoadContentAsync != null)
                {
                    await page.LoadContentAsync(page);
                    page.IsLoaded = true;
                }
            }
        }
        StateHasChanged();
    }

    // ******************************************

}